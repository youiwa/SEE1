<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- PyScriptの読み込み -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <!-- <link rel="stylesheet" href="pyscript.css" />
    <script defer src="pyscript.js"></script> -->

    <!-- PyScriptで使うパッケージを指定 -->
    <py-config>
        packages = ["matplotlib","pandas"]
    </py-config>
</head>

<body>
    <script type="py">
    # ライブラリのインポート宣言
    from pyscript import display
    import matplotlib.pyplot as plt
    import numpy as np
    import pandas as pd
    from pyodide.http import open_url
    from matplotlib import dates as mdates
    from datetime import datetime as dt
    from js import document
    
    # 線の色などの設定
    c1,c2 = "blue","green"
    l1,l2 = "temperature","humidity"
    mark1,mark2 = "o", "s"

    s_time = '14:30'
    e_time = '15:30'

    def plot_graph():
        # グラフを描画する前に既存のグラフをクリア
        plt.clf()
        container = document.getElementById('mlp')
        container.innerHTML = ''

        # 表の設定
        fig, ax1 = plt.subplots()
        ax2 =  ax1.twinx()

        # 目盛りの描画設定
        ax1.grid(axis='x')

        # 日時を取得
        t_date_str = document.getElementById('target-date').value
        if not t_date_str:
            print("Please select a start date.")
            return       
        t_date_obj = dt.strptime(t_date_str, '%Y-%m-%d')
        t_date = t_date_obj.strftime('%Y%m%d')
        s_time = js.document.getElementById("start_time").value
        e_time = js.document.getElementById("end_time").value

        # CSVファイルの読込
        try:
            csv_content = open_url(t_date+'.csv')
            df = pd.read_csv(csv_content)
        except Exception as e:
            print(f"Error loading CSV file: {e}")
            return
        # display(df)
        # display(df['time'])

        # 描画用データの抽出
        x = df['time']
        xlist = [dt.strptime(d, '%H:%M:%S') for d in x]
        t = df['temp']
        h = df['hum']
        
        # X軸の設定 (目盛りを１時間毎,範囲は 0:00～23:59とする)
        ax1.xaxis.set_major_locator(mdates.MinuteLocator(interval=30))
        ax1.xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
        ax1.set_xlim([dt.strptime(s_time,'%H:%M'), dt.strptime(e_time,'%H:%M')])
        # y軸の設定
        t_max = 10 + max(t)
        h_max = 10 + max(h)
        ax1.set_ylim([0, t_max])
        ax1.set_ylabel("temperature")
        ax2.set_ylim([0, h_max])
        ax2.set_ylabel("humidity")

        # グラフ描画
        ax1.plot(xlist, t, color=c1, label=l1, marker=mark1)
        ax2.plot(xlist, h, color=c2, label=l2, marker=mark2)
        #ax2.bar(xlist, h, color=c2, alpha=0.4, width=0.1, label=l2)

        #グラフタイトルを付ける
        plt.title("temperature & humidity", fontsize=20)

        # 凡例の表示のため、handler1と2にはグラフオブジェクトのリスト情報が入る
        # label1と2には、凡例用に各labelのリスト情報が入る
        handler1, label1 = ax1.get_legend_handles_labels()
        handler2, label2 = ax2.get_legend_handles_labels()
        # 凡例をまとめて出力する
        ax1.legend(handler1 + handler2, label1 + label2, loc=2, borderaxespad=0.5)

        fig.tight_layout()
        display(plt, target="mlp")
    </script>

    <div align="center">
        <label for="target-date">Target : </label>
        <input type="date" id="target-date" name="target-date">
        <select id="start_time">
            <option value="0:00">0:00</option>
            <option value="1:00">1:00</option>
            <option value="2:00">2:00</option>
            <option value="3:00">3:00</option>
            <option value="4:00">4:00</option>
            <option value="5:00">5:00</option>
            <option value="6:00">6:00</option>
            <option value="7:00">7:00</option>
            <option value="8:00">8:00</option>
            <option value="9:00">9:00</option>
            <option value="10:00">10:00</option>
            <option value="11:00">11:00</option>
            <option value="12:00">12:00</option>
            <option value="13:00">13:00</option>
            <option value="14:00">14:00</option>
            <option value="15:00">15:00</option>
            <option value="16:00">16:00</option>
            <option value="17:00">17:00</option>
            <option value="18:00">18:00</option>
            <option value="19:00">19:00</option>
            <option value="20:00">20:00</option>
            <option value="21:00">21:00</option>
            <option value="22:00">22:00</option>
            <option value="23:00">23:00</option>
        </select>
        －
        <select id="end_time">
            <option value="0:00">0:00</option>
            <option value="1:00">1:00</option>
            <option value="2:00">2:00</option>
            <option value="3:00">3:00</option>
            <option value="4:00">4:00</option>
            <option value="5:00">5:00</option>
            <option value="6:00">6:00</option>
            <option value="7:00">7:00</option>
            <option value="8:00">8:00</option>
            <option value="9:00">9:00</option>
            <option value="10:00">10:00</option>
            <option value="11:00">11:00</option>
            <option value="12:00">12:00</option>
            <option value="13:00">13:00</option>
            <option value="14:00">14:00</option>
            <option value="15:00">15:00</option>
            <option value="16:00">16:00</option>
            <option value="17:00">17:00</option>
            <option value="18:00">18:00</option>
            <option value="19:00">19:00</option>
            <option value="20:00">20:00</option>
            <option value="21:00">21:00</option>
            <option value="22:00">22:00</option>
            <option value="23:00">23:00</option>
        </select>
        <!-- <input id="start_time" class="py-input" value='14:00' type="text"> -->
        <!-- <input id="end_time" class="py-input" value='15:00' type="text"> -->
        <button id="er-draw" class="py-button" type="submit" py-click="plot_graph()">
            Draw Graph
        </button>
    </div>

    <!-- グラフの描画先を指定 --- (*2) -->
    <br><br>
    <p id="mlp" align="center"></p>

</body>

</html>